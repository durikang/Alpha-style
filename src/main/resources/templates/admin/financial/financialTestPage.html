<!doctype html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/admin/layouts/defaultLayout}"
      layout:fragment="Content">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테스트페이지</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>



    <style>
        /* 전체 컨테이너 */
        .container {
            font-family: Arial, sans-serif;
            margin: 20px auto;
            padding: 20px;
            max-width: 1200px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        /* 제목 */
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }

        /* 탭 네비게이션 버튼 */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tabs button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .tabs button:hover {
            background-color: #0056b3;
        }

        .tabs button:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
        }

        /* 다운로드 버튼 */
        form button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px auto;
            display: block;
            border-radius: 4px;
            cursor: pointer;
        }

        form button:hover {
            background-color: #218838;
        }

        form button:focus {
            outline: none;
            box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
        }

        .tab-content_map {
            margin-top: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 400px;
            overflow: hidden; /* 스크롤 바 제거 */
        }

        /* 로딩 메시지 스타일 */
        .loading {
            text-align: center;
            color: #555;
            font-size: 16px;
            font-weight: bold;
        }
        .tab-row {
            display: flex;
            justify-content: space-between;
            gap: 20px; /* 차트와 테이블 간격 */
            margin-top: 20px;
        }

        .tab-content {
            flex: 1; /* 각 콘텐츠를 동일한 비율로 배치 */
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            height: 500px; /* 고정 높이 */
            overflow: hidden; /* 스크롤 제거 */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }

        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
<main class="container">
    <h1>연도별 데이터 그래프</h1>

    <!-- 탭 네비게이션 -->
    <div class="tabs">
        <button type="button" onclick="setYearAndLoadGraph('2020')">2020</button>
        <button type="button" onclick="setYearAndLoadGraph('2021')">2021</button>
        <button type="button" onclick="setYearAndLoadGraph('2022')">2022</button>
        <button type="button" onclick="setYearAndLoadGraph('2023')">2023</button>
        <button type="button" onclick="setYearAndLoadGraph('2024')">2024</button>
        <button type="button" onclick="setYearAndLoadGraph('all')">전체</button>
    </div>

    <!-- 다운로드 버튼 -->
    <form action="http://localhost:5000/download" method="post">
        <input type="hidden" id="selected-year" name="year" value="all">
        <button type="submit">다운로드</button>
    </form>

    <!-- 탭 콘텐츠 -->
    <div class="tab-row">
        <div class="tab-content" id="tab-content"><p>선택한 연도의 데이터 분석 결과가 여기에 표시됩니다.</p></div>
        <div class="tab-content" id="tab-content-additional">
            <table id="data-table">
                <thead>
                <tr>
                    <th>항목</th>
                    <th>값</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>매출</td>
                    <td id="sales-value">N/A</td>
                </tr>
                <tr>
                    <td>판관비</td>
                    <td id="admin-cost-value">N/A</td>
                </tr>
                <tr>
                    <td>당기순이익</td>
                    <td id="net-income-value">N/A</td>
                </tr>
                </tbody>
            </table>
            <table id="analysis-table1" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                <tr style="background-color: #f2f2f2;">
                    <th>분석 결과</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td id="analysis-td1" style="padding: 10px;">
                        이 테이블은 그래프를 어떻게 분석했는지 보여줄 예정입니다.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="tab-row">
        <div class="tab-content" id="tab-content1"><p>선택한 연도의 데이터 분석 결과가 여기에 표시됩니다.</p></div>
        <div class="tab-content" id="tab-content1-additional">
            <table id="data-table2">
                <thead>
                <tr>
                    <th>카테고리</th>
                    <th>값</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>상의</td>
                    <td id="top_value">N/A</td>
                </tr>
                <tr>
                    <td>하의</td>
                    <td id="bottom_value">N/A</td>
                </tr>
                <tr>
                    <td>운동화</td>
                    <td id="running_shoes_value">N/A</td>
                </tr>
                <tr>
                    <td>단화</td>
                    <td id="loafers_value">N/A</td>
                </tr>
                <tr>
                    <td>슬리퍼</td>
                    <td id="slippers_value">N/A</td>
                </tr>
                </tbody>
            </table>
            <table id="analysis-table2" style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                <thead>
                <tr style="background-color: #f2f2f2;">
                    <th>분석 결과</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td id="analysis-td2" style="padding: 10px;">
                        이 테이블은 그래프를 어떻게 분석했는지 보여줄 예정입니다.
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    <div class="tab-row">
        <div class="tab-content" id="tab-content2"><p>선택한 연도의 데이터 분석 결과가 여기에 표시됩니다.</p></div>
        <div class="tab-content" id="tab-content2-additional"><p>선택한 연도의 데이터 분석 결과가 여기에 표시됩니다.</p></div>
    </div>
    <div class="tab-content" id="tab-content3">
        <p>선택한 연도의 데이터 분석 결과가 여기에 표시됩니다.</p>
    </div>
    <div class="tab-content_map" id="tab-content4">
        <p>선택한 연도의 데이터 분석 결과가 여기에 표시됩니다.</p>
    </div>
</main>

<script>
    function setYearAndLoadGraph(year) {
        console.log('버튼에서 넘긴 year 값:', year); // year 값 확인
        loadDataAndRender(year);
        showAnalysisTableByYear1(year);
        showAnalysisTableByYear2(year);
    }

    // 스크립트 실행 함수
    function executeScripts(container) {
        const scripts = container.querySelectorAll('script');
        scripts.forEach((oldScript) => {
            const newScript = document.createElement('script');
            [...oldScript.attributes].forEach(attr => newScript.setAttribute(attr.name, attr.value));
            if (oldScript.src) {
                newScript.src = oldScript.src;
            } else {
                newScript.textContent = oldScript.textContent;
            }
            document.body.appendChild(newScript);
            oldScript.remove();
        });
    }

    // 데이터를 로드하고 콘텐츠를 렌더링하는 함수
    async function loadDataAndRender(year) {
        const contentIds = [
            'tab-content',
            'tab-content1',
            'tab-content2',
            'tab-content2-additional',
            'tab-content3',
            'tab-content4'
        ];

        try {
            // 로딩 메시지 표시
            contentIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = '<p class="loading">Loading...</p>';
                } else {
                    console.warn(`Element with ID '${id}' not found. Skipping.`);
                }
            });

            // 서버 요청
            const response = await fetch('http://127.0.0.1:5000/graph', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ year })
            });

            if (!response.ok) {
                throw new Error(`Error: ${response.status}`);
            }

            // JSON 데이터 파싱
            const result = await response.json();

            // HTML 콘텐츠 렌더링
            result.html_results.forEach((item, index) => {
                const contentElement = document.getElementById(contentIds[index]);
                if (contentElement) {
                    contentElement.innerHTML = item.content || `<p>${item.path} 파일을 찾을 수 없습니다.</p>`;
                    executeScripts(contentElement); // HTML 삽입 후 스크립트 실행
                } else {
                    console.warn(`Element with ID '${contentIds[index]}' not found.`);
                }
            });

            // 테이블 데이터 렌더링
            if (result.table_data) {
                renderTableData(result.table_data);
            }

            console.log(`Data for year ${year} loaded successfully.`);
        } catch (error) {
            // 에러 처리
            contentIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.innerHTML = `<p>Error: ${error.message}</p>`;
                }
            });
            console.error("Error fetching graph data:", error);
        }
    }

    // 테이블 데이터 렌더링 함수
    function renderTableData(data) {
        if (data.summary && data.summary.length > 0) {
            const overall = data.summary.find(item => item.년도 === '전체') || {};
            const summary = data.summary[0]; // 첫 번째 데이터 기준

            document.getElementById('sales-value').textContent = overall['매출']?.toLocaleString() || summary['매출']?.toLocaleString() || 'N/A';
            document.getElementById('admin-cost-value').textContent = overall['판관비']?.toLocaleString() || summary['판관비']?.toLocaleString() || 'N/A';
            document.getElementById('net-income-value').textContent = overall['당기순이익']?.toLocaleString() || summary['당기순이익']?.toLocaleString() || 'N/A';
        }

        if (data.category_sales && data.category_sales.length > 0) {
            data.category_sales.forEach(item => {
                const categoryIdMap = {
                    '상의': 'top_value',
                    '하의': 'bottom_value',
                    '운동화': 'running_shoes_value',
                    '단화': 'loafers_value',
                    '슬리퍼': 'slippers_value'
                };
                const elementId = categoryIdMap[item['카테고리']];
                if (elementId) {
                    document.getElementById(elementId).textContent = item['공급가액']?.toLocaleString() || 'N/A';
                }
            });
        }
    }

    // 버튼 클릭 이벤트 등록
    document.querySelectorAll('.tabs button').forEach(button => {
        button.addEventListener('click', (event) => {
            const year = event.target.dataset.year || event.target.textContent === '전체' ? 'all' : event.target.textContent;
            loadDataAndRender(year);
        });
    });

    function showAnalysisTableByYear1(year) {
        const td1 = document.getElementById('analysis-td1');


        // 2. 연도별 텍스트 분기
        let analysisText = '';
        switch (year) {

            case '2020':
                analysisText = `<strong>2020년 매출, 판관비 및 당기순이익 분석 요약</strong><br><br>
                            매출 대비 판관비 비율이 88.5%입니다.`;
                break;
            case '2021':
                analysisText = `<strong>2021년 매출, 판관비 및 당기순이익 분석 요약</strong><br><br>
                            ... (분석 내용)...`;
                break;
            case '2022':
                analysisText = `<strong>2022년 매출, 판관비 및 당기순이익 분석 요약</strong><br><br>
                            ... (분석 내용)...`;
                break;
            case '2023':
                analysisText = `<strong>2023년 매출, 판관비 및 당기순이익 분석 요약</strong><br><br>
                            ... (분석 내용)...`;
                break;
            case '2024':
                analysisText = `<strong>2024년 매출, 판관비 및 당기순이익 분석 요약</strong><br><br>
                            ... (분석 내용)...`;
                break;
            case 'all':
                analysisText = `<strong>전체년도 매출, 판관비 및 당기순이익 분석 요약</strong><br><br>
                            ... (분석 내용)...`;
                break;
            default:
                analysisText = `분석 결과가 없습니다.`;
        }

        // 3. 셀에 HTML 삽입
        td1.innerHTML = analysisText;
    }
    function showAnalysisTableByYear2(year) {
        const td2 = document.getElementById('analysis-td2');

        // 2. 연도별 텍스트 분기
        let analysisText = '';
        switch (year) {
            case '2020':
                analysisText = `<strong>2020년 카테고리별 분석 요약</strong><br><br>
                            매출 대비 판관비 비율이 88.5%입니다.`;
                break;
            case '2021':
                analysisText = `<strong>2021년 카테고리별 분석 요약</strong><br><br>
                            ... (분석 내용)...`;
                break;
            case '2022':
                analysisText = `<strong>2022년 카테고리별 분석 요약</strong><br><br>
                            ... (분석 내용)...`;
                break;
            case '2023':
                analysisText = `<strong>2023년 카테고리별 분석 요약</strong><br><br>
                            ... (분석 내용)...`;
                break;
            case '2024':
                analysisText = `<strong>2024년 카테고리별 분석 요약</strong><br><br>
                            ... (분석 내용)...`;
                break;
            case 'all':
                analysisText = `<strong>전체년도 카테고리별 분석 요약</strong><br><br>
                            ... (분석 내용)...`;
                break;
            default:
                analysisText = `분석 결과가 없습니다.`;
        }

        // 3. 셀에 HTML 삽입
        td2.innerHTML = analysisText;
    }
</script>




</body>
</html>